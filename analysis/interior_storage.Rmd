---
title: "Ocean interior storage"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup_obs.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r load_library}
library(ggnewscale)
library(scales)
```


# Data

```{r set_file_path}

path_updata <- "/nfs/kryo/work/updata/"
path_emlr_preprocessing <- "/nfs/kryo/work/jenmueller/emlr_cant/observations/preprocessing/"

file_khatiwala <- paste0(path_updata,
                         "cant_khatiwala_2009/carbon_inventory_khatiwala_2009.txt")


```

## Gruber 2019

```{r read_G19}

dcant_inv_G19 <-
  read_csv(paste(path_emlr_preprocessing,
                  "G19_dcant_inv_publ.csv",
                  sep = ""))


dcant_G19 <- bind_cols(year = 2007, dcant_mean = 34, dcant_sd = 4)

```

## Sabine 2004

```{r read_S04}

tcant_inv_S04 <-
  read_csv(paste(path_emlr_preprocessing,
                  "S04_tcant_inv.csv", sep = ""))

tcant_inv_S04 <- tcant_inv_S04 %>% 
  select(-c(tcant, inv_depth, basin_AIP))

tcant_S04 <- bind_cols(year = 1994, dcant_mean = 118, dcant_sd = 19)

```

## Khatiwala

```{r read_khatiwala}

khatiwala <- read_table(file_khatiwala)

```

## GCB 2021

```{r read_GCB}

# Historical_Budget <-
#   read_csv(paste(path_emlr_preprocessing,
#                   "GCB_Historical_Budget.csv",
#                   sep = ""))

Ocean_Sink <- 
  read_csv(paste(path_emlr_preprocessing,
                  "Ocean_Sink.csv",
                  sep = ""))
```

## Atm CO2

```{r read_atm_CO2}

co2_atm_reccap2 <-
  read_csv(paste(path_emlr_preprocessing,
                  "co2_atm_reccap2.csv",
                  sep = ""))

```


# Column inventories

## Join data

```{r merge_G19_S04}

tcant_2007 <- full_join(dcant_inv_G19,
                        tcant_inv_S04)

# map data coverage
tcant_2007 <- tcant_2007 %>% 
  mutate(data_missing = if_else(is.na(dcant_pos), "G19", "available"),
         data_missing = if_else(is.na(tcant_pos), "S04", data_missing),
         data_missing = if_else(is.na(tcant_pos) & is.na(dcant_pos), "S04&G19", data_missing))

# calculate total Cant in 2007
tcant_2007 <- tcant_2007 %>% 
  mutate(tcant_pos = tcant_pos + dcant_pos)

# relative contribution of 1994 - 2007 period to total in 2007
tcant_2007_contribution <- tcant_2007 %>% 
  mutate(G19_contribution = 100* dcant_pos / tcant_pos) %>% 
  select(-starts_with(c("dcant", "tcant", "data")))

tcant_2007 <- tcant_2007 %>% 
  select(lon, lat, tcant = tcant_pos, data_missing)

```

## Maps

```{r plot_maps, fig.asp=0.5}

cant_label <- expression(atop(C["ANT"],
                                "[mol" ~ m ^ { -2 }~"]"))

p_data_coverage <- map +
  geom_tile(data = tcant_2007 %>% filter(data_missing != "available"),
            aes(lon, lat, fill = data_missing)) +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  new_scale("fill") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank())

p_data_coverage
  
p_tcant_continous <- map +
  geom_tile(data = tcant_2007 %>% filter(!is.na(tcant)),
            aes(lon, lat, fill = tcant)) +
  scale_fill_continuous_sequential("rocket",
                                   name = cant_label) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

p_tcant_continous

p_tcant_binned <- map +
  geom_tile(data = tcant_2007 %>% filter(!is.na(tcant)),
            aes(lon, lat, fill = tcant)) +
  scale_fill_binned_sequential("rocket",
                               name = cant_label,
                               breaks = seq(0,100,10)) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

p_tcant_binned

p_tcant_continous + p_tcant_binned + p_data_coverage + 
  plot_layout(ncol = 1)

ggsave(here::here("output/Fig1b.jpg"),
       width = 6,
       height = 6)

map +
  geom_tile(data = tcant_2007_contribution %>% filter(!is.na(G19_contribution)),
            aes(lon, lat, fill = G19_contribution)) +
  scale_fill_binned_divergingx(palette = "RdBu",
                               breaks = c(-Inf, seq(10, 50, 5), Inf),
                               mid = 25)



```

## Write files

```{r write column inventory files}

tcant_2007 <- tcant_2007 %>%
  mutate(lon = if_else(lon > 360, lon - 360, lon))

tcant_2007 %>% 
  ggplot(aes(lon, lat)) +
  geom_tile() +
  coord_quickmap()

tcant_2007 %>% 
  write_csv(here::here("output/Fig1b_data.csv"))


```



# Time series

## Prepare data

### Delta C*

```{r prepare_SO4_G19}

tcant_ts <- full_join(
  tcant_S04 %>% mutate(reference = "Sabine et al. (2004)"),
  dcant_G19 %>% mutate(reference = "Sabine et al. (2004) + Gruber et al. (2019)"))

tcant_ts <- left_join(tcant_ts, co2_atm_reccap2)

# co2_atm_pi <- bind_cols(pCO2 = 280, dcant_mean = 0, year = 1800, dcant_sd = 0)
# 
# tcant_ts <- full_join(tcant_ts, co2_atm_pi)

tcant_ts <- tcant_ts %>% 
  arrange(year) %>% 
  mutate(tcant = cumsum(dcant_mean),
         tcant_sd = sqrt(dcant_sd^2 + lag(dcant_sd, default = 0)^2))

tcant_ts <- tcant_ts %>% 
  mutate(method = "dC*",
         tcant_max = tcant + tcant_sd,
         tcant_min = tcant - tcant_sd) %>% 
  select(year, pCO2, reference, method, tcant, tcant_max, tcant_min)

```

### GCB models

```{r prepare_GCB}

Ocean_Sink <- Ocean_Sink %>% 
  group_by(year, type) %>% 
  summarise(GtC_mean = mean(GtC),
            GtC_sd = sd(GtC)) %>% 
  ungroup()


Ocean_Sink <- Ocean_Sink %>%
  filter(type == "models") %>%
  select(-type)

Ocean_Sink %>%
  ggplot(aes(
    year,
    GtC_mean,
    ymin = GtC_mean - GtC_sd,
    ymax = GtC_mean + GtC_sd
  )) +
  geom_ribbon(alpha = 0.3) +
  geom_path()

Ocean_Sink <- left_join(Ocean_Sink, co2_atm_reccap2)


Ocean_Sink %>%
  ggplot(aes(
    pCO2,
    GtC_mean,
    ymin = GtC_mean - GtC_sd,
    ymax = GtC_mean + GtC_sd
  )) +
  geom_ribbon(alpha = 0.3) +
  geom_path()


Ocean_Sink <- Ocean_Sink %>% 
  mutate(tcant_max = GtC_mean + GtC_sd,
         tcant_min = GtC_mean - GtC_sd,
         reference = "Friedlingstein et al. (2022)",
         method = "GCB~models") %>% 
  select(year, pCO2, reference, method, tcant = GtC_mean, tcant_max, tcant_min)

```

### Green function

```{r time_series, fig.asp=0.8}

khatiwala_m <- 
  khatiwala %>% 
  select(Year, ends_with("m"), -atm) %>% 
  pivot_longer(ends_with("m"),
               values_to = "m",
               names_to = "parameter") %>% 
  mutate(parameter = str_remove(parameter, "m"))

khatiwala_p <- 
  khatiwala %>% 
  select(Year, ends_with("p"), -atm) %>% 
  pivot_longer(ends_with("p"),
               values_to = "p",
               names_to = "parameter") %>% 
  mutate(parameter = str_remove(parameter, "p"))

khatiwala <- khatiwala %>% 
  select(Year, atm, ocean, fossil, landuse) %>% 
  pivot_longer(-Year,
               values_to = "value",
               names_to = "parameter")

khatiwala <- full_join(khatiwala, khatiwala_m) 
khatiwala <- full_join(khatiwala, khatiwala_p) 


khatiwala %>%
  filter(parameter == "ocean") %>% 
  group_split(parameter) %>%
  map(
    ~ ggplot(data = .x,
             aes(Year, value)) +
      geom_hline(yintercept = 0, linetype = 2) +
      geom_line() +
      labs(title = .x$parameter) +
      geom_ribbon(aes(ymin = m, ymax = p), alpha = 0.3)
  )


khatiwala_atm <- left_join(khatiwala %>% rename(year = Year),
                           co2_atm_reccap2)

khatiwala_atm <- khatiwala_atm %>%
  filter(parameter == "ocean") %>%
  select(-parameter)


khatiwala_atm <- khatiwala_atm %>%
  select(year, pCO2, tcant = value, tcant_max = p, tcant_min = m) %>% 
  mutate(reference = "Khatiwala et al. (2009)",
         method = "Green~\"function\"")

```

## Plot

```{r khatiwala_vs_models}

tcant_1958 <- khatiwala_atm %>% 
  filter(year == 1958) %>% 
  pull(tcant)

Ocean_Sink <- Ocean_Sink %>% 
  mutate(tcant = tcant + tcant_1958,
         tcant_max = tcant_max + tcant_1958,
         tcant_min = tcant_min + tcant_1958)


tcant <- bind_rows(tcant_ts,
                   Ocean_Sink,
                   khatiwala_atm)

ggplot() +
  geom_path(data = tcant %>% filter(method %in% c("GCB~models", "Green~\"function\"")),
            aes(pCO2, tcant,
                col = method)) +
  geom_ribbon(data = tcant %>% filter(method %in% c("GCB~models", "Green~\"function\"")),
            aes(pCO2, ymin = tcant_min, ymax = tcant_max,
                fill = method), alpha = 0.3) +
  geom_errorbar(
    data = tcant %>% filter(method %in% c("dC*")),
    aes(
      pCO2,
      tcant,
      ymin = tcant_min,
      ymax = tcant_max,
      col = "Delta*C*\"*\""),
    width = 2
  ) +
  geom_point(
    data = tcant %>% filter(method %in% c("dC*")),
    aes(pCO2,
        tcant,
        fill = "Delta*C*\"*\""),
    shape = 21
  ) +
  scale_fill_manual(values = c("firebrick", "black", "steelblue"),
                    labels = parse_format()) +
  scale_color_manual(values = c("firebrick", "black", "steelblue"),
                     guide = "none",
                     labels = parse_format()) +
  labs(x = expression(Atmospheric ~ pCO[2] ~ "[µatm]"),
       y = expression(C[ANT] ~ inventory ~ "[PgC]")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.text.align = 0)

ggsave(here::here("output/Fig1a.jpg"))
ggsave(here::here("output/Fig1a.pdf"))
ggsave(here::here("output/Fig1a.eps"))
ggsave(here::here("output/Fig1a.svg"))

```


```{r time_series_delta, fig.asp=0.8, eval=FALSE}

khatiwala %>%
  pivot_longer(value:p,
               names_to = "estimate",
               values_to = "value") %>%
  arrange(Year) %>%
  group_by(parameter, estimate) %>%
  mutate(value_delta = value - lag(value)) %>%
  ungroup() %>%
  select(-value) %>%
  pivot_wider(names_from = estimate,
              values_from = value_delta) %>%
  rename(value_delta = value) %>% 
  group_split(parameter) %>%
  map(
    ~ ggplot(data = .x, aes(Year, value_delta)) +
      geom_hline(yintercept = 0, linetype = 2) +
      geom_line() +
      labs(title = .x$parameter) +
      geom_ribbon(aes(
        ymin = m, ymax = p), alpha = 0.3)
  )

```

