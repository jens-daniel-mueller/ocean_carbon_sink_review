---
title: "Ocean interior storage"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup_obs.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r load_library}
library(ggnewscale)
theme_set(theme_linedraw())
```


# Data

```{r set_file_path}

path_updata <- "/nfs/kryo/work/updata/"
path_emlr_preprocessing <- "/nfs/kryo/work/jenmueller/emlr_cant/observations/preprocessing/"

file_khatiwala <- paste0(path_updata,
                         "cant_khatiwala_2009/carbon_inventory_khatiwala_2009.txt")


```

## Gruber 2019

```{r read_G19}

dcant_inv_G19 <-
  read_csv(paste(path_emlr_preprocessing,
                  "G19_dcant_inv.csv",
                  sep = ""))


dcant_G19 <- bind_cols(year = 2007, dcant_mean = 34, dcant_sd = 4)

```

## Sabine 2004

```{r read_S04}

tcant_inv_S04 <-
  read_csv(paste(path_emlr_preprocessing,
                  "S04_tcant_inv.csv", sep = ""))

tcant_S04 <- bind_cols(year = 1994, dcant_mean = 118, dcant_sd = 19)

```

## Khatiwala

```{r read_khatiwala}

khatiwala <- read_table2(file_khatiwala)

```

## GCB 2021

```{r read_GCB}

Historical_Budget <-
  read_csv(paste(path_emlr_preprocessing,
                  "GCB_Historical_Budget.csv",
                  sep = ""))
Ocean_Sink <- 
  read_csv(paste(path_emlr_preprocessing,
                  "Ocean_Sink.csv",
                  sep = ""))
```

## Atm CO2

```{r read_atm_CO2}

co2_atm_reccap2 <-
  read_csv(paste(path_emlr_preprocessing,
                  "co2_atm_reccap2.csv",
                  sep = ""))

```


# Column inventory map

```{r merge_G19_S04}

tcant_2007 <- full_join(dcant_inv_G19,
                        tcant_inv_S04)

tcant_2007 <- tcant_2007 %>% 
  mutate(data_missing = if_else(is.na(dcant), "G19", "available"),
         data_missing = if_else(is.na(tcant), "S04", data_missing),
         data_missing = if_else(is.na(tcant) & is.na(dcant), "S04&G19", data_missing),
         tcant = tcant + dcant,
         tcant_pos = tcant_pos + dcant_pos) %>% 
  select(-c(inv_depth, basin_AIP)) %>% 
  rename(tcant_all = tcant,
         dcant_all = dcant) 

tcant_2007_contribution <- tcant_2007 %>% 
  mutate(G19_contribution_all = 100* dcant_all / tcant_all,
         G19_contribution_pos = 100* dcant_pos / tcant_pos) %>% 
  select(-starts_with(c("dcant", "tcant", "data"))) %>% 
  pivot_longer(starts_with("G19"),
               names_to = "estimate",
               values_to = "G19_contribution",
               names_prefix = "G19_contribution_")

tcant_2007 <- tcant_2007 %>% 
  select(-starts_with("dcant")) %>% 
  pivot_longer(starts_with("tcant"),
               names_to = "estimate",
               values_to = "tcant",
               names_prefix = "tcant_") %>% 
  mutate(tcant_disc = cut(tcant, seq(-100,200,10)),
         tcant_disc = fct_rev(tcant_disc))

```

```{r plot_maps, fig.asp=1}


map +
  # geom_tile(data = tcant_2007 %>% filter(data_missing != "available"),
  #           aes(lon, lat, fill = data_missing)) +
  # scale_fill_brewer(palette = "Set3", direction = -1) +
  # new_scale("fill")+
  geom_tile(data = tcant_2007 %>% filter(!is.na(tcant)),
            aes(lon, lat, fill = tcant)) +
  scale_fill_continuous_sequential("rocket") +
  facet_grid(estimate ~ .)

map +
  geom_tile(
    data = tcant_2007 %>% filter(!is.na(tcant)),
    aes(lon, lat, fill=tcant_disc)) +
  scale_fill_discrete_sequential("rocket", rev = FALSE) +
  facet_grid(estimate ~ .)


tcant_2007_contribution <- tcant_2007_contribution %>% 
  mutate(G19_contribution_disc = cut(G19_contribution, c(-Inf,seq(10,50,5), Inf)),
         G19_contribution_disc = fct_rev(G19_contribution_disc))

map +
  geom_tile(data = tcant_2007_contribution %>% filter(!is.na(G19_contribution)),
            aes(lon, lat, fill = G19_contribution_disc)) +
  scale_fill_discrete_sequential("rocket", rev = FALSE) +
  facet_grid(estimate ~ .)

```




# Time series

```{r prepare_SO4_G19}

tcant_ts <- full_join(
  tcant_S04 %>% mutate(reference = "Sabine et al. (2004)"),
  dcant_G19 %>% mutate(reference = "Sabine et al. (2004) +\nGruber et al. (2019)"))

tcant_ts <- left_join(tcant_ts, co2_atm_reccap2)

# co2_atm_pi <- bind_cols(pCO2 = 280, dcant_mean = 0, year = 1800, dcant_sd = 0)
# 
# tcant_ts <- full_join(tcant_ts, co2_atm_pi)

tcant_ts <- tcant_ts %>% 
  arrange(year) %>% 
  mutate(tcant = cumsum(dcant_mean),
         tcant_sd = sqrt(dcant_sd^2 + lag(dcant_sd, default = 0)^2))
```


```{r prepare_GCB}

Ocean_Sink <- Ocean_Sink %>% 
  group_by(year, type) %>% 
  summarise(GtC_mean = mean(GtC),
            GtC_sd = sd(GtC)) %>% 
  ungroup()

Ocean_Sink %>%
  filter(type == "models") %>% 
  ggplot(aes(
    year,
    GtC_mean,
    ymin = GtC_mean - GtC_sd,
    ymax = GtC_mean + GtC_sd
  )) +
  geom_ribbon(alpha = 0.3) +
  geom_path()

Historical_Budget %>%
  filter(estimate == "ocean sink") %>% 
  ggplot(aes(
    year,
    GtC
  )) +
  geom_path()

Historical_Budget <- Historical_Budget %>% 
  filter(estimate == "ocean sink",
         year <= 1958) %>% 
  select(year, GtC_mean = GtC)

Historical_Budget_max <- Historical_Budget %>% 
  filter(year == max (year)) %>% 
  pull(GtC_mean)


Ocean_Sink <- Ocean_Sink %>%
  filter(type == "models") %>% 
  select(-type) %>% 
  mutate(GtC_mean = GtC_mean + Historical_Budget_max)

Ocean_Sink <- bind_rows(
  Historical_Budget,
  Ocean_Sink
)

Ocean_Sink %>%
  ggplot(aes(
    year,
    GtC_mean,
    ymin = GtC_mean - GtC_sd,
    ymax = GtC_mean + GtC_sd
  )) +
  geom_ribbon(alpha = 0.3) +
  geom_path()


Ocean_Sink <- left_join(Ocean_Sink, co2_atm_reccap2)


Ocean_Sink %>%
  ggplot(aes(
    pCO2,
    GtC_mean,
    ymin = GtC_mean - GtC_sd,
    ymax = GtC_mean + GtC_sd
  )) +
  geom_ribbon(alpha = 0.3) +
  geom_path()


```



## total

```{r time_series, fig.asp=0.8}

khatiwala_m <- 
  khatiwala %>% 
  select(Year, ends_with("m"), -atm) %>% 
  pivot_longer(ends_with("m"),
               values_to = "m",
               names_to = "parameter") %>% 
  mutate(parameter = str_remove(parameter, "m"))

khatiwala_p <- 
  khatiwala %>% 
  select(Year, ends_with("p"), -atm) %>% 
  pivot_longer(ends_with("p"),
               values_to = "p",
               names_to = "parameter") %>% 
  mutate(parameter = str_remove(parameter, "p"))

khatiwala <- khatiwala %>% 
  select(Year, atm, ocean, fossil, landuse) %>% 
  pivot_longer(-Year,
               values_to = "value",
               names_to = "parameter")

khatiwala <- full_join(khatiwala, khatiwala_m) 
khatiwala <- full_join(khatiwala, khatiwala_p) 


khatiwala %>%
  group_split(parameter) %>%
  map(
    ~ ggplot(data = .x,
             aes(Year, value)) +
      geom_hline(yintercept = 0, linetype = 2) +
      geom_line() +
      labs(title = .x$parameter) +
      geom_ribbon(aes(ymin = m, ymax = p), alpha = 0.3)
  )

```

```{r khatiwala_vs_models}

khatiwala_atm <- left_join(khatiwala %>% rename(year = Year),
          co2_atm_reccap2) %>% 
  filter(parameter == "ocean") %>% 
  select(-parameter)


Ocean_Sink %>%
  ggplot() +
  geom_path(data = khatiwala_atm,
            aes(pCO2, value,
                col = "Khatiwala et al. (2009)")) +
  geom_ribbon(
    data = khatiwala_atm,
    aes(
      pCO2,
      ymin = m,
      ymax = p,
      fill = "Khatiwala et al. (2009)"
    ),
    alpha = 0.3
  ) +
    geom_ribbon(
    aes(
      pCO2,
      GtC_mean,
      ymin = GtC_mean - GtC_sd,
      ymax = GtC_mean + GtC_sd,
      fill = "GCB models"
    ),
    alpha = 0.3
  ) +

    geom_errorbar(data = tcant_ts,
                  aes(
                    pCO2,
                    tcant,
                    ymin = tcant - tcant_sd,
                    ymax = tcant + tcant_sd,
                    col = reference
                  ), width = 2) +
      geom_point(data = tcant_ts,
                  aes(
                    pCO2,
                    tcant,
                    fill = reference
                  ), shape = 21) +
  geom_path(aes(pCO2,
                GtC_mean,
                col = "GCB models")) +
  scale_fill_manual(values = c("black", "steelblue", "firebrick", "darkorange")) +
  scale_color_manual(values = c("black", "steelblue", "firebrick", "darkorange"),
                     guide = "none") +
  labs(x = expression(Atmospheric ~ pCO[2] ~ "[µatm]"),
       y = expression(C[ANT] ~ inventory ~ "[PgC]")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.8,0.2))



```



## rates

```{r time_series_delta, fig.asp=0.8}

khatiwala %>%
  pivot_longer(value:p,
               names_to = "estimate",
               values_to = "value") %>%
  arrange(Year) %>%
  group_by(parameter, estimate) %>%
  mutate(value_delta = value - lag(value)) %>%
  ungroup() %>%
  select(-value) %>%
  pivot_wider(names_from = estimate,
              values_from = value_delta) %>%
  rename(value_delta = value) %>% 
  group_split(parameter) %>%
  map(
    ~ ggplot(data = .x, aes(Year, value_delta)) +
      geom_hline(yintercept = 0, linetype = 2) +
      geom_line() +
      labs(title = .x$parameter) +
      geom_ribbon(aes(
        ymin = m, ymax = p), alpha = 0.3)
  )

```

