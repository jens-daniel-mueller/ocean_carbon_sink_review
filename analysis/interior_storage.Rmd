---
title: "Ocean interior storage"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r load_library}
library(tidyverse)
theme_set(theme_linedraw())
```


# Data

```{r set_file_path}

path_updata <- "/nfs/kryo/work/updata/"

file_khatiwala <- paste0(path_updata,
                         "cant_khatiwala_2009/carbon_inventory_khatiwala_2009.txt")


```


## Khatiwala

```{r read_khatiwala}

khatiwala <- read_table2(file_khatiwala)

```

# Time series

## total

```{r time_series, fig.asp=0.8}

khatiwala_m <- 
  khatiwala %>% 
  select(Year, ends_with("m"), -atm) %>% 
  pivot_longer(ends_with("m"),
               values_to = "m",
               names_to = "parameter") %>% 
  mutate(parameter = str_remove(parameter, "m"))

khatiwala_p <- 
  khatiwala %>% 
  select(Year, ends_with("p"), -atm) %>% 
  pivot_longer(ends_with("p"),
               values_to = "p",
               names_to = "parameter") %>% 
  mutate(parameter = str_remove(parameter, "p"))

khatiwala <- khatiwala %>% 
  select(Year, atm, ocean, fossil, landuse) %>% 
  pivot_longer(-Year,
               values_to = "value",
               names_to = "parameter")

khatiwala <- full_join(khatiwala, khatiwala_m) 
khatiwala <- full_join(khatiwala, khatiwala_p) 


khatiwala %>%
  group_split(parameter) %>%
  map(
    ~ ggplot(data = .x,
             aes(Year, value)) +
      geom_hline(yintercept = 0, linetype = 2) +
      geom_line() +
      labs(title = .x$parameter) +
      geom_ribbon(aes(ymin = m, ymax = p), alpha = 0.3)
  )

```

## rates

```{r time_series_delta, fig.asp=0.8}

khatiwala %>%
  pivot_longer(value:p,
               names_to = "estimate",
               values_to = "value") %>%
  arrange(Year) %>%
  group_by(parameter, estimate) %>%
  mutate(value_delta = value - lag(value)) %>%
  ungroup() %>%
  select(-value) %>%
  pivot_wider(names_from = estimate,
              values_from = value_delta) %>%
  rename(value_delta = value) %>% 
  group_split(parameter) %>%
  map(
    ~ ggplot(data = .x, aes(Year, value_delta)) +
      geom_hline(yintercept = 0, linetype = 2) +
      geom_line() +
      labs(title = .x$parameter) +
      geom_ribbon(aes(
        ymin = m, ymax = p), alpha = 0.3)
  )

```

